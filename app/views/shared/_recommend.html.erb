<div class="container px-4 py-10 sm:px-6 lg:px-8 lg:py-14 mx-auto">
  <% if logged_in? %>
    <% if @recommended_gyms.present? %>
      <h3 class="text-lg font-semibold mb-6">あなたにおすすめのジム</h3>
      <div class="row justify-content-center g-3">
        <% @recommended_gyms.first(3).each do |gym| %>
          <div class="col-12 col-sm-6 col-md-4">
            <div class="card shadow-sm" style="width: 18rem;">
              <%= image_tag(@gym_images[gym.id] || 'fake.jpg', size: "150x150", class: "card-img-top", alt: "Gym Image") %>
              <div class="card-body">
                <h6 class="card-title"><%= link_to gym.name, gym_path(gym) %></h6>
                <div class="average-rating d-flex align-items-center mb-3">
                  <p>評価: <%= @average_ratings[gym.id] %></p>
                  <div class="stars">
                    <div id="average-star-rating-<%= gym.id %>" class="raty"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <h3 class="text-lg font-semibold mb-6">よく見られているジムはこちら</h3>
      <div class="row justify-content-center g-3">
        <% @popular_gyms.each do |gym| %>
          <div class="col-12 col-sm-6 col-md-4">
            <div class="card shadow-sm" style="width: 18rem;">
              <%= image_tag(@gym_images[gym.id] || 'fake.jpg', size: "150x150", class: "card-img-top", alt: "Gym Image") %>
              <div class="card-body">
                <h6 class="card-title"><%= link_to gym.name, gym_path(gym) %></h6>
                <div class="average-rating d-flex align-items-center mb-3">
                  <p>評価: <%= @average_ratings[gym.id] %></p>
                  <div class="stars">
                    <div id="average-star-rating-<%= gym.id %>" class="raty"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
  <% else %>
    <h3 class="text-lg font-semibold mb-6">よく見られているジムはこちら</h3>
    <div class="row justify-content-center g-3">
      <% @popular_gyms.first(3).each do |gym| %>
        <div class="col-12 col-sm-6 col-md-4">
          <div class="card shadow-sm" style="width: 18rem;">
            <%= image_tag(@gym_images[gym.id] || 'fake.jpg', size: "150x150", class: "card-img-top", alt: "Gym Image") %>
            <div class="card-body">
              <h6 class="card-title"><%= link_to gym.name, gym_path(gym) %></h6>
              <div class="average-rating d-flex align-items-center mb-3">
                <p>評価: <%= @average_ratings[gym.id] %></p>
                <div class="stars">
                  <div id="average-star-rating-<%= gym.id %>" class="raty"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>
</div>
</div>



<script>
  document.addEventListener('turbo:load', function() {
    console.log("turbo:loadイベントがトリガーされました");
    const gyms = <%= @gyms.map { |gym| { id: gym.id, rating: @average_ratings[gym.id] } }.to_json.html_safe %>;
    console.log("ジム一覧:", gyms);
    gyms.forEach(function(gym) {
      const averageRatingElement = document.getElementById('average-star-rating-' + gym.id);
      console.log("処理中のジム:", gym.id, "評価要素:", averageRatingElement);
      if (averageRatingElement && !averageRatingElement.classList.contains('raty-initialized')) {
        averageRatingElement.classList.add('raty-initialized');
        new Raty(averageRatingElement, {
          size: 20,
          starOff: '/assets/star-off.png',
          starOn: '/assets/star-on.png',
          starHalf: '/assets/star-half.png',
          score: gym.rating,
          readOnly: true
        }).init();
        console.log("Ratyが初期化されました:", gym.id);
      }
    });
  });
</script>

<style>
.average-rating p {
  margin-bottom: 0;
}

.average-rating .stars {
  display: flex;
  align-items: center;
  margin-left: 10px;
}

.average-rating .raty img {
  width: 20px; /* アイコンのサイズを調整 */
  height: 20px;
}
</style>
